import { NextRequest, NextResponse } from 'next/server'
import Anthropic from '@anthropic-ai/sdk'

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY || '',
})

export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    const { variances, companyName, fiscalYear } = body

    if (!variances || !Array.isArray(variances)) {
      return NextResponse.json(
        { error: '差異データが必要です' },
        { status: 400 }
      )
    }

    // Claude APIを使用して分析コメントを生成
    const prompt = `以下は${companyName}の${fiscalYear}年度の予算実績比較データです。財務アナリストとして、専門的な分析コメントを日本語で作成してください。

【会社名について】
- タイトルや本文で会社名を使用する場合は、必ず「${companyName}」を正確に使用してください
- 絶対に他の会社名に置き換えたり、間違えたりしないでください

データ:
${variances.map((v: any) => `${v.label}: 予算 ${v.budget?.toLocaleString()}円, 実績 ${v.actual?.toLocaleString()}円, 差異 ${v.variance?.toLocaleString()}円, 達成率 ${v.achievement?.toFixed(1)}%`).join('\n')}

【重要な注意事項】
- この分析は上記の予算実績データのみに基づく分析です
- 業界平均や他社との比較は行わないでください（データがないため）
- 「業界トップレベル」「市場をリード」などの断定的表現は使用しないでください
- 提供されたデータのみに基づいた客観的な分析を行ってください
- 推測や誇張表現は避け、数値に基づいた事実のみを記述してください
- 営業外収支や特別損益、税金費用などデータにない項目について推測しないでください

【絶対に禁止される分析】
- 財務諸表項目間で達成率を比較すること（例：売上高の達成率105%と営業利益の達成率106.7%を比較）
- 「経常利益の達成率が売上高を上回る」などの項目間の達成率比較
- 「利益の下段階ほど達成率が高い」などの項目間の達成率の傾向分析
- このような分析は素人コメントとみなされます

【表現スタイル】
- 金額の単位は億円に統一してください（例：5,000万円→0.5億円）
- 「予算比プラス」「予算比マイナス」という表現を使用してください
- 各項目ごとに予算と実績を比較してください（項目間の達成率比較はNG）
- PL全体の収支構造についてコメントしてください
- 段階利益の説明はPLの上から下への流れに沿ってください（例：売上総利益→販管費→営業利益→営業外損益→経常利益）
- 計算上明らかな事実に「推察されます」「考えられます」などの推測表現は使用しないでください
- 「売上増加による粗利改善効果をより多く営業利益に反映させる」「本業での収益力強化に注力」などの抽象的・一般的な提案は避けてください

以下の観点で分析してください：
1. 全体的な業績評価（各項目の予算達成状況）
2. 売上高と利益率の状況（売上高の達成状況、利益率の予算比変化）
3. PL全体の収支構造（PLの上から下への流れで説明：売上総利益→販管費→営業利益→営業外損益→経常利益→当期純利益）
4. 改善提案（具体的かつ簡潔に、抽象的な一般論は避ける。例：「販管費のコスト管理を強化することが課題です」）

【段階利益の説明例】
例1：
良い例：「売上総利益段階で予算比プラス0.3億円でしたが、販管費予算比プラス0.2億円に伴い、営業利益段階では0.1億円のプラスとなりました。」
悪い例：「売上総利益段階での予算比プラス0.3億円のうち、営業利益段階では0.1億円のプラスとなっており、販管費が予算比0.2億円増加したことが推察されます。」

例2（PL全体の収支構造）：
良い例：「売上高の伸長により売上総利益は予算比プラス0.3億円を確保しました。一方で、販売費及び一般管理費は予算比プラス0.2億円となり、営業利益段階では予算比プラス0.1億円に留まりました。営業外収支が予算比プラス0.05億円改善したため経常利益段階では予算比プラス0.15億円、税金費用の予算比増加があったため当期純利益は予算比プラス0.1億円となりました。」
悪い例：「売上原価は予算比プラス0.2億円となりましたが、売上高の伸びにより売上総利益は予算比プラス0.3億円を確保しました。販売費及び一般管理費は予算比プラス0.2億円となり、営業利益段階では予算比プラス0.1億円となりました。営業外収支は予算比プラス0.05億円改善し、経常利益段階では予算比プラス0.15億円となっています。税金費用等を経て、当期純利益は予算比プラス0.1億円となりました。」

【重要なポイント】
- 売上原価の詳細は省略し、売上総利益から説明を始める
- 「一方で」「ため」などの接続詞で論理の流れを明確にする
- 「留まりました」などの評価表現で増減の意味を示す
- 段階間の移行時には要因を明示する（例：「税金費用の予算比増加があったため」）

【表現の注意点】
- ポイントや%の改善は「予算比1.0ポイント改善」（「予算比プラス1.0ポイント改善」は冗長）
- 金額のプラスは「予算比プラス1.0億円」（この場合は「プラス」を使用）
- 税金費用等の表現は「税金費用等を控除した当期純利益は」（「税金費用等を経て」ではなく「控除した」を使用）

回答は簡潔に、3-4つの段落にまとめてください。各段落は2-3文程度にしてください。`

    const message = await anthropic.messages.create({
      model: 'claude-sonnet-4-5-20250929',
      max_tokens: 1500,
      messages: [
        {
          role: 'user',
          content: prompt,
        },
      ],
    })

    const analysis = message.content[0].type === 'text' ? message.content[0].text : ''

    return NextResponse.json({ analysis })
  } catch (error) {
    console.error('AI分析エラー:', error)
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'AI分析に失敗しました' },
      { status: 500 }
    )
  }
}
