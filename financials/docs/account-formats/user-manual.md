# カスタム科目体系フォーマット - ユーザーマニュアル

## 目次
1. [はじめに](#1-はじめに)
2. [基本操作](#2-基本操作)
3. [フォーマットの作成](#3-フォーマットの作成)
4. [フォーマットの編集](#4-フォーマットの編集)
5. [フォーマットのコピー](#5-フォーマットのコピー)
6. [フォーマットのエクスポート](#6-フォーマットのエクスポート)
7. [フォーマットのインポート](#7-フォーマットのインポート)
8. [財務分析でのフォーマット利用](#8-財務分析でのフォーマット利用)
9. [よくある質問](#9-よくある質問)

---

## 1. はじめに

### 1.1 カスタム科目体系フォーマットとは？

カスタム科目体系フォーマットは、売上高・売上原価・売上総利益の科目構成を事前に定義し、財務分析時に再利用できる機能です。

### 1.2 どんな時に使うの？

- 同じ業種の複数企業を分析する場合
- 特定の企業で定期的に財務分析を行う場合
- 部門ごとに異なる科目体系を管理したい場合
- 科目入力の手間を省きたい場合

### 1.3 主な機能

✅ フォーマットの作成・編集・削除
✅ フォーマットのコピー
✅ JSON形式でのエクスポート/インポート
✅ 業種別の自動適用
✅ 企業へのフォーマット割り当て

---

## 2. 基本操作

### 2.1 フォーマット管理画面へのアクセス

1. メニューから「科目フォーマット管理」を選択
2. または、URLで直接アクセス: `http://localhost:3001/account-formats`

### 2.2 フォーマット一覧の見方

フォーマット一覧には以下の情報が表示されます：

| 項目 | 説明 |
|------|------|
| フォーマット名 | フォーマットの名称 |
| 業種 | 関連付けられた業種（未設定の場合もあり） |
| 科目数 | 登録されている科目の数 |
| 公開設定 | 「共有」または「専用」<br>・共有: 他のユーザーも使用可能<br>・専用: 自分だけが使用可能 |
| 更新日 | 最終更新日時 |

### 2.3 操作ボタン

各フォーマットには以下のボタンがあります：

| ボタン | アイコン | 説明 |
|--------|---------|------|
| 編集 | ✏️ | フォーマットの内容を変更 |
| コピー | 📋 | フォーマットを複製 |
| エクスポート | ⬇️ | JSON形式でダウンロード |
| 削除 | 🗑️ | フォーマットを削除 |

---

## 3. フォーマットの作成

### 3.1 新規フォーマットの作成手順

1. **「新規作成」ボタンをクリック**
   - フォーマット管理画面右上の「新規作成」ボタンをクリックします

2. **基本情報を入力**
   - **フォーマット名**（必須）: わかりやすい名前を付けます
     - 例: 「製造業標準フォーマット」「自社カスタム」
   - **説明**（任意）: フォーマットの用途や特徴を記載
     - 例: 「製造業向けの標準的な科目体系」
   - **業種**（任意）: 関連する業種を選択
     - 選択すると、その業種の企業で自動的にこのフォーマットが推奨されます
   - **共有設定**: チェックを入れると他のユーザーも使用可能になります

3. **科目を追加**
   - 「科目を追加」ボタンをクリック
   - 以下の項目を設定します：
     - **カテゴリ**: 「売上高」「売上原価」「売上総利益」から選択
     - **科目名**: 具体的な科目名を入力（例: 「製品売上高」「原材料費」）
     - **階層**: レベル0〜3で階層を設定
       - レベル0: 最上位（例: 「売上高」）
       - レベル1: 中分類（例: 「製品売上高」）
       - レベル2: 小分類（例: 「国内売上」）
       - レベル3: 詳細（例: 「関東地区売上」）
     - **合計行**: 合計を表示する行の場合はチェック

4. **保存**
   - 「保存」ボタンをクリックして完了

### 3.2 科目設定のポイント

#### ✅ 良い例
```
売上高（レベル0、合計行）
├─ 製品売上高（レベル1）
│  ├─ 国内売上（レベル2）
│  └─ 海外売上（レベル2）
└─ サービス売上高（レベル1）
```

#### ❌ 避けるべき例
- 科目名が曖昧（「その他」だけでは何を指すか不明）
- 階層が深すぎる（レベル4以上は設定できません）
- 合計行の設定漏れ

---

## 4. フォーマットの編集

### 4.1 編集手順

1. フォーマット一覧から編集したいフォーマットの「編集」ボタン（✏️）をクリック
2. 基本情報や科目を変更
3. 「保存」ボタンをクリック

### 4.2 注意事項

⚠️ **既に企業に割り当て済みのフォーマットを編集すると、割り当て先の企業にも影響します**

編集前に確認すべきこと：
- このフォーマットはどの企業で使われているか
- 変更内容が他の企業の分析に影響しないか

### 4.3 科目の追加・削除

**科目を追加する場合**:
1. 「科目を追加」ボタンをクリック
2. 新しい行が追加されるので、必要な情報を入力

**科目を削除する場合**:
1. 削除したい科目の行の右端にある「🗑️」ボタンをクリック
2. 確認なしで即座に削除されるので注意

---

## 5. フォーマットのコピー

### 5.1 コピー機能の使い方

既存のフォーマットをベースに新しいフォーマットを作りたい場合に便利です。

1. フォーマット一覧からコピーしたいフォーマットの「コピー」ボタン（📋）をクリック
2. ポップアップで新しいフォーマット名を入力
   - デフォルトでは「{元のフォーマット名}のコピー」という名前が提案されます
3. OKをクリック
4. コピーされたフォーマットは自動的に「専用フォーマット」として作成されます

### 5.2 活用例

**共有フォーマットを自社用にカスタマイズ**:
1. 「製造業標準フォーマット」（共有）をコピー
2. 「当社製造業フォーマット」という名前で保存
3. 自社固有の科目を追加・編集

---

## 6. フォーマットのエクスポート

### 6.1 エクスポート手順

フォーマットをJSON形式でファイルに保存できます。

1. フォーマット一覧からエクスポートしたいフォーマットの「エクスポート」ボタン（⬇️）をクリック
2. 自動的にJSONファイルがダウンロードされます
   - ファイル名: `format_{フォーマット名}_{日付}.json`
   - 例: `format_製造業標準フォーマット_2025-11-02.json`

### 6.2 エクスポートファイルの用途

- **バックアップ**: フォーマットの控えとして保管
- **共有**: 他のシステムやユーザーとフォーマットを共有
- **移行**: 別環境へのフォーマット移行

### 6.3 エクスポートデータの構造

```json
{
  "name": "製造業標準フォーマット",
  "description": "製造業向けの標準的な科目体系",
  "industry_id": "uuid",
  "is_shared": true,
  "items": [
    {
      "category": "売上高",
      "account_name": "製品売上高",
      "display_order": 1,
      "level": 0,
      "is_total": false
    }
  ]
}
```

---

## 7. フォーマットのインポート

### 7.1 インポート手順

JSONファイルからフォーマットを読み込みます。

1. フォーマット管理画面右上の「インポート」ボタンをクリック
2. JSONファイルを選択
3. 自動的にフォーマットが作成されます

### 7.2 注意事項

⚠️ **正しいJSON形式のファイルのみインポート可能です**

必須フィールド：
- `name`: フォーマット名
- `items`: 科目リスト（配列）

### 7.3 インポートエラーが発生した場合

**「無効なフォーマットファイルです」と表示される**:
- JSON形式が正しくない
- 必須フィールド（name, items）が欠けている

**対処法**:
1. エクスポート機能で生成されたJSONファイルの形式を参考にする
2. JSONバリデーターでファイルをチェックする

---

## 8. 財務分析でのフォーマット利用

### 8.1 新規分析作成時のフォーマット選択

1. 「新規財務分析」画面を開く
2. **ステップ1: 企業情報**で以下を入力
   - 企業名
   - 業種（選択すると該当業種のフォーマットが自動選択されます）
   - **科目体系フォーマット**: ドロップダウンから選択
     - 「使用しない」を選ぶことも可能

3. 以降のステップを進めて分析を作成

### 8.2 業種別自動適用の仕組み

**自動選択の条件**:
- 業種が選択されている
- その業種に関連付けられた「共有フォーマット」が存在する
- まだフォーマットが手動で選択されていない

**例**:
1. 業種で「製造業」を選択
2. 「製造業標準フォーマット」（業種=製造業、共有=true）が自動的に選択されます

### 8.3 フォーマットを変更したい場合

業種を選択した後でも、フォーマットを手動で変更できます：

1. フォーマット選択ドロップダウンをクリック
2. 別のフォーマットを選択、または「使用しない」を選択

---

## 9. よくある質問

### Q1. 共有フォーマットと専用フォーマットの違いは？

**共有フォーマット** (`is_shared = true`):
- 全ユーザーが閲覧・使用可能
- 業種別自動適用の対象になる
- 標準的なフォーマットとして推奨される

**専用フォーマット** (`is_shared = false`):
- 作成者のみが使用可能
- 企業固有のカスタマイズに適している

### Q2. フォーマットを削除するとどうなる？

- フォーマット本体と関連する科目項目が削除されます
- 企業への割り当て情報も削除されます
- ⚠️ 削除は元に戻せないので注意してください

### Q3. 同じ企業に複数のフォーマットを割り当てられる？

はい、可能です。ただし、**アクティブなフォーマットは常に1つのみ**です。

### Q4. フォーマットを作成したのに財務分析で使えない

以下を確認してください：
1. フォーマットが正しく保存されているか（一覧に表示されるか）
2. 新規分析作成画面でフォーマット一覧が読み込まれているか
3. ブラウザをリロードしてみる

### Q5. 業種を選択してもフォーマットが自動選択されない

以下の条件を確認してください：
- その業種に関連付けられた共有フォーマットが存在するか
- 既に手動でフォーマットを選択していないか

### Q6. インポートしたフォーマットの業種が「未設定」になる

エクスポート元とインポート先で業種のIDが異なる場合、業種は自動的に関連付けられません。
インポート後に手動で業種を設定してください。

### Q7. フォーマットの階層（レベル）はどう使い分ける？

**推奨される使い分け**:
- **レベル0**: 大分類（売上高、売上原価など）
- **レベル1**: 中分類（製品売上高、サービス売上高など）
- **レベル2**: 小分類（国内売上、海外売上など）
- **レベル3**: 詳細（地域別、製品別など）

レベルが深すぎると管理が複雑になるので、必要に応じて2〜3レベルに抑えることをお勧めします。

### Q8. 科目の表示順序を変更したい

現在、科目の表示順序は`display_order`フィールドで自動的に管理されています。
科目を削除して追加し直すか、編集画面で順序を調整してください。

---

## サポート

質問や問題がある場合は、以下までお問い合わせください：
- GitHubイシュー: https://github.com/arakawak223/financials/issues
- メール: support@example.com（例）

---

**最終更新日**: 2025年11月2日
**バージョン**: 1.0.0
