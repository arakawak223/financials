# カスタム科目体系フォーマット機能 - 機能仕様書

## 1. 概要

### 1.1 機能の目的
カスタム科目体系フォーマット機能は、業種や企業ごとに異なる売上高・売上原価・売上総利益の科目構成を事前に定義し、財務分析時に再利用できるようにする機能です。これにより、企業ごとに毎回科目を手入力する手間を省き、分析の効率化と一貫性を実現します。

### 1.2 主な機能
1. 科目フォーマットの作成・編集・削除
2. フォーマットのコピー機能
3. フォーマットのインポート/エクスポート（JSON形式）
4. 企業へのフォーマット割り当て
5. 業種別デフォルトフォーマット自動適用
6. 財務分析作成時のフォーマット選択

## 2. データ構造

### 2.1 科目フォーマット（account_formats）
- **id**: UUID（主キー）
- **name**: 文字列（フォーマット名）
- **description**: 文字列（説明、任意）
- **industry_id**: UUID（業種ID、外部キー、任意）
- **is_shared**: 真偽値（共有フォーマットかどうか）
- **created_by**: UUID（作成者ID）
- **created_at**: タイムスタンプ（作成日時）
- **updated_at**: タイムスタンプ（更新日時）

### 2.2 科目フォーマット項目（account_format_items）
- **id**: UUID（主キー）
- **format_id**: UUID（フォーマットID、外部キー）
- **category**: 文字列（カテゴリ: 売上高、売上原価、売上総利益）
- **account_name**: 文字列（科目名）
- **display_order**: 整数（表示順序）
- **parent_id**: UUID（親項目ID、任意）
- **level**: 整数（階層レベル: 0-3）
- **calculation_formula**: 文字列（計算式、任意）
- **is_total**: 真偽値（合計行かどうか）
- **created_at**: タイムスタンプ（作成日時）
- **updated_at**: タイムスタンプ（更新日時）

### 2.3 企業フォーマット割り当て（company_account_formats）
- **id**: UUID（主キー）
- **company_id**: UUID（企業ID、外部キー）
- **format_id**: UUID（フォーマットID、外部キー）
- **is_active**: 真偽値（アクティブかどうか）
- **assigned_at**: タイムスタンプ（割り当て日時）
- **assigned_by**: UUID（割り当て者ID）

## 3. 機能詳細

### 3.1 科目フォーマットの作成
**画面**: `/account-formats`

**手順**:
1. 「新規作成」ボタンをクリック
2. 基本情報を入力
   - フォーマット名（必須）
   - 説明（任意）
   - 業種（任意）
   - 共有設定（真偽値）
3. 科目を追加
   - 「科目を追加」ボタンをクリック
   - カテゴリ選択（売上高、売上原価、売上総利益）
   - 科目名入力
   - 階層レベル選択（0-3）
   - 合計行設定
4. 「保存」ボタンで登録完了

**バリデーション**:
- フォーマット名は必須
- 最低1つ以上の科目が必要
- 科目名は必須

### 3.2 科目フォーマットの編集
**画面**: `/account-formats`

**手順**:
1. フォーマット一覧から編集したいフォーマットの「編集」ボタンをクリック
2. 基本情報や科目を編集
3. 「保存」ボタンで更新完了

**注意事項**:
- 既に企業に割り当て済みのフォーマットを編集すると、割り当て先の企業にも影響します

### 3.3 科目フォーマットのコピー
**画面**: `/account-formats`

**手順**:
1. フォーマット一覧からコピーしたいフォーマットの「コピー」ボタンをクリック
2. 新しいフォーマット名を入力
3. コピーされたフォーマットは「専用フォーマット」（is_shared = false）として作成されます

**利用シーン**:
- 既存のフォーマットをベースに、少しだけカスタマイズしたフォーマットを作りたい場合
- 共有フォーマットを自社用に調整したい場合

### 3.4 科目フォーマットのエクスポート
**画面**: `/account-formats`

**手順**:
1. フォーマット一覧からエクスポートしたいフォーマットの「エクスポート」ボタンをクリック
2. JSON形式のファイルが自動的にダウンロードされます

**ファイル名形式**:
`format_{フォーマット名}_{日付}.json`

**エクスポートデータ構造**:
```json
{
  "name": "製造業標準フォーマット",
  "description": "製造業向けの標準的な科目体系",
  "industry_id": "uuid",
  "is_shared": true,
  "items": [
    {
      "category": "売上高",
      "account_name": "製品売上高",
      "display_order": 1,
      "parent_id": null,
      "level": 0,
      "calculation_formula": null,
      "is_total": false
    }
  ]
}
```

### 3.5 科目フォーマットのインポート
**画面**: `/account-formats`

**手順**:
1. 「インポート」ボタンをクリック
2. JSONファイルを選択
3. 自動的にフォーマットが作成されます

**バリデーション**:
- JSON形式が正しいこと
- name フィールドが存在すること
- items が配列形式であること

### 3.6 企業へのフォーマット割り当て
**機能**: 特定の企業に科目フォーマットを割り当てる

**API**: `POST /api/account-formats/{id}/assign`

**リクエスト**:
```json
{
  "company_id": "uuid",
  "is_active": true
}
```

**動作**:
- `is_active = true`で割り当てる場合、他のアクティブなフォーマットは自動的に非アクティブになります
- 1つの企業に対して複数のフォーマットを割り当て可能ですが、アクティブなのは常に1つのみ

### 3.7 業種別デフォルトフォーマット自動適用
**画面**: `/analysis/new`（新規分析作成）

**動作**:
1. 企業情報入力ステップで業種を選択
2. その業種に該当する共有フォーマット（is_shared = true）が存在する場合、自動的に選択されます
3. ユーザーは手動で別のフォーマットに変更することも可能

**条件**:
- 業種IDが一致すること
- フォーマットが共有フォーマットであること
- まだフォーマットが手動選択されていないこと

### 3.8 財務分析作成時のフォーマット選択
**画面**: `/analysis/new`

**手順**:
1. 企業情報入力ステップで「科目体系フォーマット」を選択
2. 利用可能なフォーマット一覧から選択
3. 「使用しない」を選択することも可能

**選択されたフォーマットの用途**:
- 財務分析データの`format_id`として保存されます
- 将来的に科目詳細入力時にフォーマット項目を表示するために使用される予定

## 4. ユーザーインターフェース

### 4.1 フォーマット管理画面
- **パス**: `/account-formats`
- **表示項目**:
  - フォーマット名
  - 業種
  - 科目数
  - 公開設定（共有/専用）
  - 更新日
  - 操作ボタン（編集、コピー、エクスポート、削除）
- **ヘッダーボタン**:
  - インポート
  - 新規作成

### 4.2 フォーマット編集画面
- **基本情報セクション**:
  - フォーマット名（テキスト入力）
  - 説明（テキストエリア）
  - 業種（セレクトボックス）
  - 共有設定（スイッチ）
- **科目設定セクション**:
  - 科目一覧テーブル
    - カテゴリ（セレクトボックス）
    - 科目名（テキスト入力）
    - 階層（セレクトボックス: レベル0-3）
    - 合計行（スイッチ）
    - 削除ボタン
  - 「科目を追加」ボタン
- **アクションボタン**:
  - キャンセル
  - 保存

## 5. セキュリティ・権限

### 5.1 Row Level Security (RLS)
- 各テーブルにRLSポリシーが設定されています
- ユーザーは自分が作成したフォーマットまたは共有フォーマットのみアクセス可能
- 共有フォーマット（is_shared = true）は全ユーザーが閲覧可能

### 5.2 操作権限
- **作成**: すべてのユーザー
- **編集**: フォーマット作成者のみ
- **削除**: フォーマット作成者のみ
- **閲覧**: 作成者 + 共有フォーマットの場合は全ユーザー
- **コピー**: すべてのユーザー（共有フォーマットを含む）

## 6. 今後の拡張予定

### 6.1 科目詳細入力時のフォーマット項目表示
現在は基本統合のみ完了しており、財務データ入力画面でフォーマット項目を直接表示・入力する機能は今後実装予定です。

### 6.2 フォーマットテンプレート
業種別の標準的なフォーマットテンプレートを事前定義し、簡単に利用開始できるようにする予定です。

### 6.3 フォーマットバージョン管理
フォーマットの変更履歴を保持し、過去のバージョンに戻せるようにする予定です。

## 7. トラブルシューティング

### 7.1 フォーマットが自動選択されない
**原因**:
- 業種に一致する共有フォーマットが存在しない
- フォーマットが既に手動で選択されている

**対処**:
- 該当業種の共有フォーマットを作成する
- 手動で別のフォーマットを選択する

### 7.2 インポートに失敗する
**原因**:
- JSONファイルの形式が不正
- 必須フィールドが欠けている

**対処**:
- エクスポート機能で生成されたJSONファイルの形式を参考にする
- name と items フィールドが正しく含まれているか確認する

## 8. 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-11-02 | 1.0.0 | 初版作成 |
